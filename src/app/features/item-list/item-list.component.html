<div class="item-list-container">
  <h1>Item List</h1>
  <p class="subtitle">Complete list of available items</p>

  <div class="controls-section">
    <div class="search-section">
      <label for="searchInput">Search by Name:</label>
      <input
        type="text"
        id="searchInput"
        [(ngModel)]="searchTerm"
        (input)="onSearchChange()"
        placeholder="Enter item name..."
        class="search-input"
      >
    </div>
    <div class="filter-section">
      <label for="categoryFilter">Filter by Category:</label>
      <select id="categoryFilter" [(ngModel)]="selectedCategory" (change)="onCategoryChange()" class="category-dropdown">
        <option value="">All Categories</option>
        <option *ngFor="let category of categories" [value]="category.name">{{ category.name }}</option>
      </select>
    </div>
    <div class="action-section">
      <button class="btn create-btn" (click)="openCreateModal()">Create New Item</button>
      <button class="btn import-btn" (click)="showImportForm = !showImportForm">Import from Excel</button>
    </div>
  </div>

  <div class="alert alert-error" *ngIf="errorMessage && !showModal">
    {{ errorMessage }}
  </div>

  <div class="import-form" *ngIf="showImportForm">
    <div class="import-card">
      <h2>Import Items from Excel</h2>
      <p class="import-description">Upload an Excel file with your items. Use the template below to ensure the correct format.</p>

      <button class="btn btn-secondary" (click)="downloadTemplate()">Download Template</button>

      <div class="file-upload-area">
        <input
          type="file"
          #fileInput
          (change)="onFileSelected($event)"
          accept=".xlsx,.xls,.csv"
          style="display: none"
        >
        <button class="btn btn-upload" (click)="fileInput.click()" [disabled]="importLoading">
          {{ importLoading ? 'Uploading...' : 'Choose File' }}
        </button>
      </div>

      <div class="import-message" *ngIf="importMessage">
        <p [ngClass]="{'success': importMessage.includes('Success'), 'error': importMessage.includes('failed') || importMessage.includes('Please')}">
          {{ importMessage }}
        </p>
      </div>
    </div>
  </div>

  <div class="stats-section">
    <div class="stat-card">
      <h3>Total Items</h3>
      <p>{{ filteredItems.length }}</p>
    </div>
    <div class="stat-card">
      <h3>Categories</h3>
      <p>{{ categories.length }}</p>
    </div>
    <div class="stat-card">
      <h3>Selected Category</h3>
      <p>{{ selectedCategory || 'All' }}</p>
    </div>
  </div>

  <div class="table-section">
    <table class="data-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Category</th>
          <th>Purchase (₹)</th>
          <th>Sale (₹)</th>
          <th>MRP (₹)</th>
          <th>Sequence</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of filteredItems; let i = index">
          <td>{{ item.name }}</td>
          <td>
            <span class="category-badge" [class]="getCategoryClass(item.category)">
              {{ item.category || 'N/A' }}
            </span>
          </td>
          <td class="text-center">{{ item.purchase || 0 }}</td>
          <td class="text-center">{{ item.sale || 0 }}</td>
          <td class="text-center">{{ item.mrp || 0 }}</td>
          <td class="text-center">{{ item.sequence }}</td>
          <td class="text-center">
            <button class="btn-action edit-btn" (click)="openEditModal(item)">Edit</button>
            <button class="btn-action delete-btn" (click)="deleteItem(item)">Delete</button>
          </td>
        </tr>
        <tr *ngIf="loading" class="no-data-row">
          <td colspan="7" class="text-center">Loading...</td>
        </tr>
        <tr *ngIf="!loading && filteredItems.length === 0" class="no-data-row">
          <td colspan="7" class="text-center">No items found matching your criteria</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ isEditMode ? 'Edit Item' : 'Create New Item' }}</h2>
      <button class="close-btn" (click)="closeModal()">&times;</button>
    </div>

    <div class="modal-body">
      <div class="alert alert-error" *ngIf="errorMessage">
        {{ errorMessage }}
      </div>

      <form (ngSubmit)="saveItem()">
        <div class="form-group">
          <label for="itemName">Name <span class="required">*</span></label>
          <input
            type="text"
            id="itemName"
            [(ngModel)]="itemForm.name"
            name="name"
            class="form-input"
            placeholder="Enter item name"
            required
          >
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="itemBusinessCategory">Business Category <span class="required">*</span></label>
            <select
              id="itemBusinessCategory"
              [(ngModel)]="itemForm.business_category"
              name="business_category"
              class="form-input"
              required
            >
              <option value="">Select a business category</option>
              <option *ngFor="let bc of businessCategories" [value]="bc.Name">{{ bc.Name }}</option>
            </select>
          </div>

          <div class="form-group">
            <label for="itemCategory">Category <span class="required">*</span></label>
            <select
              id="itemCategory"
              [(ngModel)]="itemForm.category"
              name="category"
              class="form-input"
              required
            >
              <option value="">Select a category</option>
              <option *ngFor="let category of categories" [value]="category.name">{{ category.name }}</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="itemPurchase">Purchase <span class="required">*</span></label>
            <input
              type="number"
              id="itemPurchase"
              [(ngModel)]="itemForm.purchase"
              name="purchase"
              class="form-input"
              min="0"
              step="0.01"
              required
            >
          </div>

          <div class="form-group">
            <label for="itemSale">Sale <span class="required">*</span></label>
            <input
              type="number"
              id="itemSale"
              [(ngModel)]="itemForm.sale"
              name="sale"
              class="form-input"
              min="0"
              step="0.01"
              required
            >
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="itemMRP">MRP <span class="required">*</span></label>
            <input
              type="number"
              id="itemMRP"
              [(ngModel)]="itemForm.mrp"
              name="mrp"
              class="form-input"
              min="0"
              step="0.01"
              required
            >
          </div>

          <div class="form-group">
            <label for="itemSequence">Sequence <span class="required">*</span></label>
            <input
              type="number"
              id="itemSequence"
              [(ngModel)]="itemForm.sequence"
              name="sequence"
              class="form-input"
              min="0"
              required
            >
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn cancel-btn" (click)="closeModal()">Cancel</button>
          <button type="submit" class="btn save-btn" [disabled]="loading">
            {{ loading ? 'Saving...' : 'Save' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
